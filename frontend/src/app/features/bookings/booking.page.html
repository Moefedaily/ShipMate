<div class="booking-page">
  
  @if (loading()) {
    <p class="muted">
      <mat-icon style="animation: spin 1s linear infinite; vertical-align: middle; margin-right: 8px;">refresh</mat-icon>
      Loading booking details…
    </p>
  }
  
  @if (errorMessage()) {
    <div class="error-banner" role="alert">
      {{ errorMessage() }}
    </div>
  }
  
  @if (booking()) {
    
    <div class="page-header">
      <div>
      <button class="btn btn--ghost back-btn" routerLink="/dashboard/driver">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
         <h1>Current Delivery</h1>
        <p class="subtitle">
          Track and manage your active booking with real-time updates
        </p>
      </div>
      <span class="badge" [ngClass]="statusBadgeClass()">
        {{ status() }}
      </span>
    </div>
    
    <section class="card booking-map">
      <app-leaflet-map
        mode="route"
        [stops]="mapStops()"
      />
    </section>
    
    <section class="card booking-details">
      
      <!-- Route Stops Section -->
      <div class="details-section">
        <h2 class="section-title">Route Stops</h2>
        
        <ul class="stops">
          @for (shipment of shipments(); track shipment.id; let i = $index) {
            <li>
              <!-- Pickup -->
              <div class="stop-row">
                <span class="stop-label pickup">
                  <mat-icon>store</mat-icon>
                  Pickup
                </span>
                <span class="stop-address">{{ shipment.pickupAddress }}</span>
              </div>
              
              <!-- Delivery -->
              <div class="stop-row">
                <span class="stop-label delivery">
                  <mat-icon>local_shipping</mat-icon>
                  Delivery
                </span>
                <span class="stop-address">{{ shipment.deliveryAddress }}</span>
              </div>
            </li>
          }
        </ul>
      </div>
      
      <div class="details-divider"></div>
      
      <!-- Earnings Section -->
      <div class="details-section">
        <h2 class="section-title">Earnings Breakdown</h2>
        
        <div class="earnings-grid">
          <div class="earning-card">
            <span class="label">Your Earnings</span>
            <strong>€{{ driverEarnings() }}</strong>
          </div>
          
          <div class="earning-card">
            <span class="label">Platform Fee</span>
            <strong>€{{ platformCommission() }}</strong>
          </div>
          
          <div class="earning-card">
            <span class="label">Total Value</span>
            <strong>€{{ totalPrice() }}</strong>
          </div>
        </div>
      </div>
      
    </section>
    
    <section class="actions">
      
      @if (status() === 'PENDING') {
        <button
          type="button"
          class="btn btn--secondary"
          (click)="cancel()"
          [disabled]="acting()"
        >
          @if (acting()) {
            <mat-icon>hourglass_empty</mat-icon>
            Cancelling…
          } @else {
            <mat-icon>close</mat-icon>
            Cancel booking
          }
        </button>
        
        <button
          type="button"
          class="btn btn--primary"
          (click)="confirm()"
          [disabled]="acting()"
        >
          @if (acting()) {
            <mat-icon>hourglass_empty</mat-icon>
            Confirming…
          } @else {
            <mat-icon>check_circle</mat-icon>
            Confirm booking
          }
        </button>
      }
      
      @if (status() === 'CONFIRMED') {
        <button
          type="button"
          class="btn btn--primary"
          (click)="start()"
          [disabled]="acting()"
        >
          @if (acting()) {
            <mat-icon>hourglass_empty</mat-icon>
            Starting…
          } @else {
            <mat-icon>play_arrow</mat-icon>
            Start delivery
          }
        </button>
      }
    </section>
    
  }
</div>

<style>
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
<div class="payment-page">

  @if (loading()) {
    <div class="loading-state">
      <mat-icon class="spin">refresh</mat-icon>
      <p>Loading payment details…</p>
    </div>
  }

  @if (errorMessage()) {
    <div class="error-banner">
      <mat-icon>error_outline</mat-icon>
      <div>
        <strong>Something went wrong</strong>
        <p>{{ errorMessage() }}</p>
      </div>
    </div>
  }

  @if (payment()) {

    <div class="page-header">
      <div class="header-content">
        <button class="btn btn--ghost back-btn" routerLink="../">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
        <div class="header-text">
          <h1>Secure Payment</h1>
          <p class="subtitle">Driver cannot start delivery until payment is secured</p>
        </div>
      </div>
      <span class="badge" [ngClass]="statusBadgeClass()">
        <span class="badge-dot"></span>
        {{ status() }}
      </span>
    </div>

    @if (!isAuthorized() && !isCaptured()) {

      @if (isWaitingAuth()) {
        <div class="processing-card">
          <div class="processing-content">
            <mat-icon class="spin">sync</mat-icon>
            <div>
              <strong>Finalizing Secure Payment</strong>
              <span>Verifying authorization with payment provider…</span>
            </div>
          </div>
          <div class="processing-bar"></div>
        </div>
      }

      <section class="card payment-card">

        <div class="payment-summary">
          <div class="summary-label">
            <mat-icon>receipt_long</mat-icon>
            <span>Order summary</span>
          </div>

          <div class="summary-row">
            <span>Base delivery price</span>
            <strong>{{ shipment()!.basePrice | currency }}</strong>
          </div>

          @if (shipment()!.insuranceSelected && shipment()!.insuranceFee) {
            <div class="summary-row insurance-row">
              <div class="summary-row-left">
                <span>Shipment insurance</span>
                @if (shipment()!.insuranceCoverageAmount) {
                  <small class="coverage-hint">Coverage up to {{ shipment()!.insuranceCoverageAmount | currency }}</small>
                }
              </div>
              <strong>+ {{ shipment()!.insuranceFee | currency }}</strong>
            </div>
          }

          <div class="summary-divider"></div>

          <div class="summary-row total">
            <span>Total</span>
            <strong>{{ payment()!.amountTotal | currency }}</strong>
          </div>
        </div>

        @if (shipment()!.insuranceSelected) {
          <div class="insurance-notice">
            <div class="insurance-notice-icon">
              <mat-icon>verified_user</mat-icon>
            </div>
            <div class="insurance-notice-text">
              <strong>Shipment insured</strong>
              <small>
                This shipment is protected against loss and damage.
                @if (shipment()!.declaredValue) {
                  Declared value: {{ shipment()!.declaredValue | currency }}.
                }
              </small>
            </div>
            @if (shipment()!.insuranceFee) {
              <span class="insurance-fee-pill">{{ shipment()!.insuranceFee | currency }}</span>
            }
          </div>
        }

        <div class="payment-element-container">
          <div id="payment-element"></div>
        </div>

        <div class="actions">
          <button
            class="btn btn--secondary"
            (click)="startPayment()"
            [disabled]="!canInitialize()"
          >
            <mat-icon>payment</mat-icon>
            Initialize Payment
          </button>
          <button
            class="btn btn--primary"
            (click)="confirmPayment()"
            [disabled]="!canConfirm()"
          >
            <mat-icon>lock</mat-icon>
            Confirm Payment
          </button>
        </div>

        <div class="security-notice">
          <mat-icon>lock</mat-icon>
          <span>Secured by Stripe — your payment information is encrypted</span>
        </div>

      </section>
    }

    @if (isAuthorized()) {
      <div class="success-card">
        <mat-icon>check_circle</mat-icon>
        <div>
          <strong>Payment Authorized</strong>
          <span>Redirecting to shipment details…</span>
        </div>
      </div>
    }

    @if (isCaptured()) {
      <div class="success-card">
        <mat-icon>verified</mat-icon>
        <div>
          <strong>Payment Completed</strong>
          <span>Payment has been successfully processed.</span>
        </div>
      </div>
    }

  }

</div>
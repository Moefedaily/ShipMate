<div class="payment-page">
  
  <!-- LOADING STATE -->
  @if (loading()) {
    <div class="loading-state">
      <mat-icon class="spin">refresh</mat-icon>
      <p>Loading payment details...</p>
    </div>
  }

  <!-- ERROR BANNER -->
  @if (errorMessage()) {
    <div class="error-banner">
      <mat-icon>error_outline</mat-icon>
      <div>
        <strong>Error</strong>
        <p>{{ errorMessage() }}</p>
      </div>
    </div>
  }

  <!-- MAIN CONTENT -->
  @if (payment()) {
    
    <!-- PAGE HEADER -->
    <div class="page-header">
      <div class="header-content">
        <button class="btn btn--ghost back-btn" routerLink="../">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
        <div class="header-text">
          <h1>Secure Payment</h1>
          <p class="subtitle">
            Driver cannot start delivery until payment is secured
          </p>
        </div>
      </div>
      <span class="badge" [ngClass]="statusBadgeClass()">
        <span class="badge-dot"></span>
        {{ status() }}
      </span>
    </div>

    <!-- PAYMENT FORM (when not completed) -->
    @if (!isAuthorized() && !isCaptured()) {
      
      <!-- PROCESSING STATE -->
      @if (isWaitingAuth()) {
        <div class="processing-card">
          <div class="processing-content">
            <mat-icon class="spin">sync</mat-icon>
            <div>
              <strong>Finalizing Secure Payment</strong>
              <span>Verifying authorization with payment provider...</span>
            </div>
          </div>
          <div class="processing-bar"></div>
        </div>
      }

      <!-- PAYMENT CARD -->
      <section class="card payment-card">
        
        <!-- Payment Summary -->
        <div class="payment-summary">
          <div class="summary-row">
            <span>Base Price</span>
            <strong>{{ shipment()!.basePrice | currency }}</strong>
          </div>
          <div class="summary-row">
            <span>Insurance Fee</span>
            <strong>{{ shipment()!.extraInsuranceFee| currency }}</strong>
          </div>
          <div class="summary-row total">
            <span>Total Amount</span>
            <strong>{{ payment()!.amountTotal | currency }}</strong>
          </div>
        </div>

        <!-- Stripe Element -->
        <div class="payment-element-container">
          <div id="payment-element"></div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button
            class="btn btn--secondary"
            (click)="startPayment()"
            [disabled]="!canInitialize()"
          >
            <mat-icon>payment</mat-icon>
            Initialize Payment
          </button>
          <button
            class="btn btn--primary"
            (click)="confirmPayment()"
            [disabled]="!canConfirm()"
          >
            <mat-icon>lock</mat-icon>
            Confirm Payment
          </button>
        </div>

        <!-- Security Notice -->
        <div class="security-notice">
          <mat-icon>lock</mat-icon>
          <span>Secured by Stripe - Your payment information is encrypted</span>
        </div>
      </section>
    }

    <!-- SUCCESS STATES -->
    @if (isAuthorized()) {
      <div class="success-card">
        <mat-icon>check_circle</mat-icon>
        <div>
          <strong>Payment Authorized</strong>
          <span>Redirecting to shipment details...</span>
        </div>
      </div>
    }

    @if (isCaptured()) {
      <div class="success-card">
        <mat-icon>verified</mat-icon>
        <div>
          <strong>Payment Completed</strong>
          <span>Payment has been successfully processed</span>
        </div>
      </div>
    }

  }
</div>
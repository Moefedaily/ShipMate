@if (activeBooking()) {

<section class="current-delivery-section">
  <div class="section-header">
    <h2>Current Delivery</h2>
    <span class="live-pill">Live Updates Active</span>
  </div>

  <section class="card current-delivery">

    <div class="delivery-map">
      <app-leaflet-map mode="route" [stops]="driverStops()"></app-leaflet-map>
      
      <div class="map-legend">
        <div class="legend-item">
          <span class="legend-dot pickup"></span>
          <span class="legend-text">Pickup</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot delivery"></span>
          <span class="legend-text">Delivery</span>
        </div>
      </div>
      
      <span class="eta-pill">
        <mat-icon>schedule</mat-icon>
        12 mins
      </span>
    </div>

    <div class="delivery-panel">

      <div class="delivery-top">
        <span class="status-pill">
          <span class="dot"></span>
          {{ activeBooking()!.status }}
        </span>

        <span class="order-id">
          Booking #{{ activeBooking()!.id | slice:0:8 }}
        </span>
      </div>

      <h3 class="delivery-title">
        @if (activeBooking()!.shipments.length <= 1) {
          {{ activeBooking()!.shipments[0]?.pickupAddress }} →
          {{ activeBooking()!.shipments[0]?.deliveryAddress }}
        } @else {
          {{ activeBooking()!.shipments.length }} deliveries in this trip
        }
      </h3>

      <div class="delivery-top-right-earning">
        <div class="earning-block">
          <span class="earning-label">Earning</span>
          <span class="earning-value">
            {{ activeBooking()!.driverEarnings | currency }}
          </span>
        </div>
      </div>

      <div class="address-row">
        @if (activeBooking()!.shipments.length <= 1) {

          <div class="address-card">
            <div class="address-label">
              <mat-icon>store</mat-icon>
              FROM
            </div>
            <strong>{{ activeBooking()!.shipments[0]?.pickupAddress }}</strong>
          </div>

          <div class="address-card">
            <div class="address-label">
              <mat-icon>location_on</mat-icon>
              TO
            </div>
            <strong>{{ activeBooking()!.shipments[0]?.deliveryAddress }}</strong>
          </div>

        } @else {

          <div class="address-card">
            <div class="address-label">
              <mat-icon>route</mat-icon>
              STOPS
            </div>
            <strong>{{ driverStops().length }} route points</strong>
          </div>

          <div class="address-card">
            <div class="address-label">
              <mat-icon>fitness_center</mat-icon>
              LOAD
            </div>
            <strong>{{ totalLoadKg() | number:'1.0-2' }} kg</strong>
          </div>

        }
      </div>

      @if (driverStops().length > 0) {
        <div class="trip-timeline">
          <div class="timeline-title">Trip Timeline</div>

          <div class="timeline-list">
            @for (s of driverStops(); track s.id; let i = $index) {

              <div class="timeline-item"
                   [class.pickup]="s.type === 'PICKUP'"
                   [class.delivery]="s.type === 'DELIVERY'">

                <div class="timeline-left">
                  <div class="step-circle">{{ i + 1 }}</div>
                  @if (i < driverStops().length - 1) {
                    <div class="step-line"></div>
                  }
                </div>

                <div class="timeline-body">
                  <div class="timeline-head">
                    <span class="step-type">
                      {{ s.type === 'PICKUP' ? 'Pickup' : 'Delivery' }}
                    </span>
                  </div>
                  
                  <div class="step-address">{{ s.address }}</div>

                  <div class="timeline-shipments">
                    @for (sh of s.shipments; track sh.id) {
                      <div class="shipment-row">
                        <div class="shipment-dot"></div>

                        <div class="shipment-text">
                          <div class="shipment-name">
                            {{ sh.label }}
                            <span class="shipment-weight">({{ sh.weightKg }} kg)</span>
                          </div>

                          @if (s.type === 'PICKUP') {
                            <div class="shipment-sub">
                              Delivering to: {{ sh.deliveryAddress }}
                            </div>
                          } @else {
                            <div class="shipment-sub">
                              Picked up from: {{ sh.pickupAddress }}
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>

                </div>
              </div>
            }
          </div>
        </div>
      }

      <div class="delivery-footer">
        <div class="meta-row">
          <span class="meta-chip">
            <mat-icon>inventory_2</mat-icon>
            {{ activeBooking()!.shipments.length }} shipment(s)
          </span>
        </div>

        <button
          class="btn btn--primary confirm-btn"
          (click)="goToBooking(activeBooking()!.id)"
        >
          @if (bookingStatus() === 'IN_PROGRESS') {
            Continue trip →
          } @else {
            View booking →
          }
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>

    </div>
  </section>
</section>

}

<section class="available-deliveries" [class.is-locked]="isBookingLocked()">

  <div class="section-header">
    <h2>Available Deliveries</h2>

    <a class="link" (click)="openMatching()">
      Find deliveries <mat-icon>open_in_new</mat-icon>
    </a>
  </div>

  @if (isBookingLocked()) {
    <div class="lock-note">
      <mat-icon>lock</mat-icon>
      @if (bookingStatus() === 'CONFIRMED') {
        Trip confirmed — no changes allowed
      } @else {
        Finish your current delivery to accept more
      }
    </div>
  }

  @if (isBuildingTrip()) {
    <div class="lock-note">
      <mat-icon>add_circle</mat-icon>
      You can add more deliveries to this trip before confirming
    </div>
  }

  @if (matches().length === 0) {
    <div class="card empty-state">
      <mat-icon>inventory_2</mat-icon>
      <p>No deliveries nearby at the moment</p>
    </div>
  } @else {
    <div class="delivery-grid">
      @for (m of matches(); track m.shipment.id) {
        <article class="card delivery-card">
          <div class="card-media">
            <span class="card-icon">
              <mat-icon>inventory_2</mat-icon>
            </span>

            <span class="distance-pill">
              {{ m.metrics.distanceToPickupKm | number:'1.1-1' }} km
            </span>
          </div>

          <div class="card-body">
            <div class="card-title-row">
              <h4>{{ m.shipment.packageDescription || 'Shipment' }}</h4>
              <span class="price">
                {{ m.shipment.basePrice | currency }}
              </span>
            </div>

            <p class="route">
              {{ m.shipment.pickupAddress }}
              <mat-icon>arrow_forward</mat-icon>
              {{ m.shipment.deliveryAddress }}
            </p>

            <div class="tag-row">
              <span class="tag">
                {{ m.shipment.packageWeight }} kg
              </span>

              <span class="tag tag--info">
                {{ m.metrics.pickupToDeliveryKm | number:'1.0-0' }} km route
              </span>
            </div>

            <button
              class="btn btn--secondary btn-full"
              [disabled]="isBookingLocked()"
              (click)="openMatching()"
            >
              View details
            </button>
          </div>
        </article>
      }
    </div>
  }
</section>

<section class="card earnings-summary">
  <div class="earnings-left">
    <div class="earnings-icon">
      <mat-icon>payments</mat-icon>
    </div>
    <div>
      <div class="earnings-title">Earnings Summary</div>
      <div class="earnings-sub">Overview of your totals</div>
    </div>
  </div>

  <div class="earnings-right">
    <div class="earning-col">
      <div class="label">TODAY</div>
      <div class="value">$45.00</div>
    </div>

    <div class="divider"></div>

    <div class="earning-col">
      <div class="label">THIS WEEK</div>
      <div class="value">$310.00</div>
    </div>
  </div>
</section>

@if (showLocationModal()) {
  <app-location-update-modal
    (updated)="onLocationModalUpdated()"
    (cancelled)="onLocationModalCancelled()"
  ></app-location-update-modal>
}
name: Frontend CI/CD

on:
  push:
    branches: [main, dev]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yml"

jobs:

  # CI JOB
  # Build, Test, and Publish Docker Image

  build:
    name: Build, Test and Publish Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend
        run: |
          echo "Installing frontend dependencies..."
          npm ci
          echo "Dependencies installed successfully."

      - name: Build Angular Application (Production Mode)
        working-directory: ./frontend
        run: |
          echo "Building Angular application in production mode..."
          npm run build -- --configuration production
          echo "Angular build completed successfully."

      - name: Login to GitHub Container Registry
        if: github.event_name == 'push'
        run: |
          echo "Logging into GHCR..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "Login successful."

      - name: Build and Push Docker Image
        if: github.event_name == 'push'
        working-directory: ./frontend
        run: |
          IMAGE="ghcr.io/moefedaily/shipmate-frontend"

          echo "Building Docker image with SHA tag..."
          docker build -f Dockerfile.prod \
            -t $IMAGE:${{ github.sha }} \
            -t $IMAGE:prod \
            .

          echo "Pushing SHA-tagged image..."
          docker push $IMAGE:${{ github.sha }}

          echo "Updating prod tag..."
          docker push $IMAGE:prod

          echo "Frontend image successfully published to GHCR."


  # CD JOB
  # Deploy using Override Strategy with Health Check & Rollback
  
  deploy:
    name: Deploy Frontend to Production (Override Strategy)
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "Connecting to production server..."
            cd /opt/shipmate

            # 1. Save current frontend image reference

            echo "Saving current frontend image reference..."
            CURRENT_IMAGE=$(docker inspect shipmate-web --format='{{.Config.Image}}' 2>/dev/null || echo "")
            echo "Current running frontend image: $CURRENT_IMAGE"

            # 2. Pull New Frontend Image

            NEW_IMAGE="ghcr.io/moefedaily/shipmate-frontend:${{ github.sha }}"
            echo "Pulling new image from registry: $NEW_IMAGE"
            docker pull $NEW_IMAGE

            # 3. Create Temporary Override File

            echo "Creating temporary docker-compose.override.yml for frontend..."
            echo "services:" > docker-compose.override.yml
            echo "  web:" >> docker-compose.override.yml
            echo "    image: $NEW_IMAGE" >> docker-compose.override.yml

            # 4. Deploy New Frontend Version

            echo "Deploying new frontend version..."
            docker compose -f docker-compose.prod.yml -f docker-compose.override.yml up -d web

            # 5. Post-Deployment Health Check

            echo "Waiting for Nginx to initialize..."
            sleep 10

            echo "Performing health check on Nginx..."

            if ! docker inspect -f '{{.State.Running}}' shipmate-web 2>/dev/null | grep -q true; then
              echo "Frontend container is not running!"
              exit 1
            fi

            if ! curl -f http://localhost; then
              echo "Health check failed. Initiating frontend rollback..."

              rm -f docker-compose.override.yml

              if [ -n "$CURRENT_IMAGE" ]; then
                echo "Restoring previous frontend image: $CURRENT_IMAGE"
                echo "services:" > docker-compose.override.yml
                echo "  web:" >> docker-compose.override.yml
                echo "    image: $CURRENT_IMAGE" >> docker-compose.override.yml
                docker compose -f docker-compose.prod.yml -f docker-compose.override.yml up -d web
                echo "Frontend rollback completed successfully."
              else
                echo "Rollback failed: No previous image reference found."
              fi

              exit 1
            fi

            # 6. Cleanup After Successful Deployment

            echo "Health check passed. Removing temporary override file..."
            rm -f docker-compose.override.yml

            echo "Frontend deployment completed successfully."
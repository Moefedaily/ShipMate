name: Frontend CI/CD

on:
  push:
    branches: [main, dev]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend.yml"

jobs:

  # CI JOB
  # Build, Test, and Publish Docker Image

  build:
    name: Build, Test and Publish Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend
        run: |
          echo "Installing frontend dependencies..."
          npm ci
          echo "Dependencies installed successfully."

      - name: Build Angular Application (Production Mode)
        working-directory: ./frontend
        run: |
          echo "Building Angular application in production mode..."
          npm run build -- --configuration production
          echo "Angular build completed successfully."

      - name: Login to GitHub Container Registry
        if: github.event_name == 'push'
        run: |
          echo "Logging into GHCR..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "Login successful."

      - name: Build and Push Docker Image
        if: github.event_name == 'push'
        working-directory: ./frontend
        run: |
          IMAGE="ghcr.io/moefedaily/shipmate-frontend"

          echo "Building Docker image with SHA tag..."
          docker build -f Dockerfile.prod \
            -t $IMAGE:${{ github.sha }} \
            -t $IMAGE:prod \
            .

          echo "Pushing SHA-tagged image..."
          docker push $IMAGE:${{ github.sha }}

          echo "Updating prod tag..."
          docker push $IMAGE:prod

          echo "Frontend image successfully published to GHCR."


    # CD JOB
  # Deploy using Immutable Compose Strategy (No Override)

  deploy:
    name: Deploy Frontend to Production (Immutable Strategy)
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "Connecting to production server..."
            cd /opt/shipmate

            # 1. Save current frontend image reference

            echo "Saving current frontend image reference..."
            CURRENT_IMAGE=$(docker inspect shipmate-web --format='{{.Config.Image}}' 2>/dev/null || echo "")
            echo "Current running frontend image: $CURRENT_IMAGE"

            # 2. Pull New Frontend Image

            NEW_IMAGE="ghcr.io/moefedaily/shipmate-frontend:${{ github.sha }}"
            echo "Pulling new image from registry: $NEW_IMAGE"
            docker pull $NEW_IMAGE

            # 3. Update docker-compose.prod.yml with new SHA

            echo "Updating docker-compose.prod.yml with new frontend SHA..."
            sed -i "s|image: ghcr.io/moefedaily/shipmate-frontend:.*|image: $NEW_IMAGE|" docker-compose.prod.yml

            # 4. Deploy New Version

            echo "Deploying new frontend version..."
            docker compose -f docker-compose.prod.yml up -d web

            # 5. Health Check

            echo "Waiting for Nginx to initialize..."
            echo "Waiting for frontend to become ready..."

            MAX_RETRIES=15
            RETRY_DELAY=2
            COUNTER=0

            until curl -fs http://localhost/index.html > /dev/null; do
              COUNTER=$((COUNTER+1))

              if [ $COUNTER -ge $MAX_RETRIES ]; then
                echo "Frontend did not become ready in time. Initiating rollback..."

                if [ -n "$CURRENT_IMAGE" ]; then
                  sed -i "s|image: ghcr.io/moefedaily/shipmate-frontend:.*|image: $CURRENT_IMAGE|" docker-compose.prod.yml
                  docker compose -f docker-compose.prod.yml up -d web
                  echo "Frontend rollback completed successfully."
                else
                  echo "Rollback failed: No previous image reference found."
                fi

                exit 1
              fi

              echo "Frontend not ready yet... retrying in ${RETRY_DELAY}s"
              sleep $RETRY_DELAY
            done

            echo "Frontend is healthy."
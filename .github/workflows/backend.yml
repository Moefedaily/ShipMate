name: Backend CI/CD

on:
  push:
    branches: [main, dev]
    paths:
      - "backend/**"
      - ".github/workflows/backend.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "backend/**"
      - ".github/workflows/backend.yml"

jobs:

  # CI JOB
  # Build, Test, and Publish Docker Image

  build:
    name: Build, Test and Publish Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: shipmate_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd="pg_isready -U test -d shipmate_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Build and Run Tests
        working-directory: ./backend
        run: |
          echo "Starting Maven build and tests..."
          mvn clean verify
          echo "Build and tests completed successfully."

      - name: Login to GitHub Container Registry
        if: github.event_name == 'push'
        run: |
          echo "Logging into GHCR..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "Login successful."

      - name: Build and Push Docker Image
        if: github.event_name == 'push'
        working-directory: ./backend
        run: |
          IMAGE="ghcr.io/moefedaily/shipmate-backend"
          echo "Building Docker image with SHA tag..."
          docker build -t $IMAGE:${{ github.sha }} -t $IMAGE:prod .
          echo "Pushing SHA-tagged image..."
          docker push $IMAGE:${{ github.sha }}
          echo "Updating prod tag..."
          docker push $IMAGE:prod
          echo "Image successfully published to GHCR."


    # CD JOB
  # Deploy using Immutable Compose Strategy (No Override)

  deploy:
    name: Deploy to Production (Immutable Strategy)
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "Connecting to production server..."
            cd /opt/shipmate

            # 1. Load environment variables

            echo "Loading environment variables from .env..."
            source .env

            # 2. Save current backend image for rollback

            echo "Saving current backend image reference..."
            CURRENT_IMAGE=$(docker inspect shipmate-backend --format='{{.Config.Image}}' 2>/dev/null || echo "")
            echo "Current running image: $CURRENT_IMAGE"

            # 3. Database Backup

            echo "Creating database backup before deployment..."
            mkdir -p backups
            docker exec shipmate-db pg_dump -U $POSTGRES_USER -d $POSTGRES_DB > backups/pre_deploy_$(date +%Y%m%d_%H%M%S).sql
            echo "Database backup completed successfully."

            echo "Cleaning old backups, keeping only the 3 most recent files..."
            ls -tp backups/pre_deploy_*.sql 2>/dev/null | grep -v '/$' | tail -n +4 | xargs -r rm --
            echo "Old backups cleaned."

            # 4. Pull New Backend Image

            NEW_IMAGE="ghcr.io/moefedaily/shipmate-backend:${{ github.sha }}"
            echo "Pulling new image from registry: $NEW_IMAGE"
            docker pull $NEW_IMAGE

            # 5. Update docker-compose.prod.yml to use new SHA

            echo "Updating docker-compose.prod.yml with new SHA..."
            sed -i "s|image: ghcr.io/moefedaily/shipmate-backend:.*|image: $NEW_IMAGE|" docker-compose.prod.yml

            # 6. Deploy New Version

            echo "Deploying new backend version..."
            echo "Waiting for backend and database to become healthy..."

            MAX_RETRIES=20
            RETRY_DELAY=3
            COUNTER=0

            until docker exec shipmate-backend curl -fs http://localhost:8080/actuator/health > /dev/null; do
              COUNTER=$((COUNTER+1))

              if [ $COUNTER -ge $MAX_RETRIES ]; then
                echo "Backend or database did not become healthy in time. Initiating rollback..."

                if [ -n "$CURRENT_IMAGE" ]; then
                  sed -i "s|image: ghcr.io/moefedaily/shipmate-backend:.*|image: $CURRENT_IMAGE|" docker-compose.prod.yml
                  docker compose -f docker-compose.prod.yml up -d backend
                  echo "Rollback completed successfully."
                else
                  echo "Rollback failed: No previous image reference found."
                fi

                exit 1
              fi

              echo "Backend or DB not ready yet... retrying in ${RETRY_DELAY}s"
              sleep $RETRY_DELAY
            done

            echo "Backend and database are healthy."